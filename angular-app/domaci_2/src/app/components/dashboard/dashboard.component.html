<div class="dashboard-container">
  <h2>Your Accounts</h2>

  <!-- GLOBAL ERROR -->
  <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>
  <!-- GLOBAL SUCCESS -->
  <div *ngIf="successMessage" class="success-message">{{ successMessage }}</div>

  <!-- Add Account (ostavljeno kako je, samo izdvojeno iznad top-section da zadrži layout) -->
  <div class="add-account-card">
    <h3>Add Account</h3>
    <form (ngSubmit)="onCreateAccount()" #f="ngForm" class="add-account-form">

      <div class="form-field">
        <label>Account name</label>
        <input
          type="text"
          name="account_name"
          [(ngModel)]="newAccountName"
          required
          placeholder="npr. Tekući račun" />
      </div>

      <div class="form-field">
        <label>Initial balance (RSD)</label>
        <input
          type="number"
          name="balance"
          [(ngModel)]="newAccountBalance"
          required
          step="0.01"
          placeholder="0,00" />
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="f.invalid || isSubmitting">
          {{ isSubmitting ? 'Saving...' : 'Add Account' }}
        </button>
      </div>

      <p *ngIf="createError" class="error-message" style="margin-top:8px">{{ createError }}</p>
    </form>
  </div>

  <div class="top-section">

    <!-- Account list (prikaz svih mojih naloga) -->
    <div class="account-list">
      <ng-container *ngIf="!isLoadingAccounts; else loadingAccounts">
        <ng-container *ngIf="accounts?.length; else noAccounts">
          <div *ngFor="let account of accounts; trackBy: trackByAccountId" class="account-card">
            <h3>{{ account.name || account.account_name }}</h3>
            <p>Balance: {{ account.balance | currencyFormat:'RSD' }}</p>

            <app-button
              label="View Transactions"
              type="secondary"
              (onClick)="viewDetails(account.id)">
              View Transactions
            </app-button>
          </div>
        </ng-container>
      </ng-container>

      <ng-template #loadingAccounts>
        <p>Loading accounts...</p>
      </ng-template>

      <ng-template #noAccounts>
        <p>You don't have any accounts yet.</p>
      </ng-template>
    </div>
    <!-- /Account list -->

    <div class="calculator">
      <h3>Savings Calculator</h3>
      <form (ngSubmit)="calculateSavings()" #savingsForm="ngForm" class="calculator-form">
        <label>Initial Amount (RSD):</label>
        <input type="number" [(ngModel)]="initialAmount" name="initialAmount" required />

        <label>Monthly Contribution (RSD):</label>
        <input type="number" [(ngModel)]="monthlyContribution" name="monthlyContribution" required />

        <label>Number of Months:</label>
        <input type="number" [(ngModel)]="months" name="months" required />

        <label>Annual Interest Rate (%):</label>
        <input type="number" [(ngModel)]="interestRate" name="interestRate" />

        <label>Display in Currency:</label>
        <select [(ngModel)]="selectedCurrency" name="selectedCurrency">
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
          <option value="CHF">CHF</option>
        </select>

        <app-button label="Calculate" type="primary">Calculate</app-button>
      </form>

      <div *ngIf="savingsTotal !== null">
        <strong>Total Savings in RSD:</strong>
        <p class="savings-result">{{ savingsTotal | number:'1.2-2' }} RSD</p>
      </div>

      <div *ngIf="convertedCurrency !== null">
        <strong>In {{ selectedCurrency }}:</strong>
        <p class="currency-result">{{ convertedCurrency | number:'1.2-2' }} {{ selectedCurrency }}</p>
      </div>
    </div>
  </div>

  <div class="charts-container">
    <div class="chart-card">
      <h3>Spendings and Savings</h3>
      <canvas baseChart
        [data]="pieChartData"
        [type]="'pie'"
        [options]="pieChartOptions"
        style="flex-grow: 1; width: 100%;"></canvas>
    </div>
    
    <div class="chart-card">
      <h3>Monthly Spending</h3>
      <canvas baseChart
        [data]="barChartData"
        [type]="'bar'"
        [options]="barChartOptions"
        style="flex-grow: 1; width: 100%;"></canvas>
    </div>
  </div>

  <div class="activity-feed">
    <h3>Recent Transactions</h3>
    <ul>
      <li *ngFor="let tx of recentTransactions">
        <strong>{{ tx.account.name || tx.account.account_name || 'No Account' }} </strong>
        <span [ngStyle]="{'color': tx.type === 'expense' ? 'red' : 'inherit'}">
          {{ tx.type === 'income' ? '+' : '-' }}
          {{ tx.amount | currencyFormat:'RSD' }}
        </span>
        <span style="float: right; font-style: italic">
          {{ tx.created_at | date:'mediumDate' }}
        </span>
      </li>
      <li *ngIf="!recentTransactions.length">No recent transactions</li>
    </ul>
  </div>
</div>